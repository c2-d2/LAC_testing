library(nlme)
library(scales)
set.seed(123)
setwd("~/LAC")
# 1 Tidying data
all_weeks <- Data_master_weekly_3
all_weeks$id <- as.numeric(as.factor(all_weeks$geo_merge))
weeks <- unique(all_weeks$epi_week)

# 2 Subsetting the validation set
test_weeks <- Data_master_weekly_3 %>%
  filter(time >= 105) 

vad_weeks <- unique(test_weeks$epi_week)

test_weeks$id <- as.numeric(as.factor(test_weeks$geo_merge))

test_clean <- test_weeks[!is.na(test_weeks$pct_pos_tminus2) & 
                         !is.na(test_weeks$pct_pos_tminus3) &
                         !is.na(test_weeks$test_rate_tminus2) &
                         !is.na(test_weeks$total_tests_tminus2) &
                         !is.na(test_weeks$pct_cum_doses_tminus2) &
                         !is.na(test_weeks$pct_cum_inc_tminus2) &
                         !is.na(test_weeks$avg_pct_pos_past_2_4wk),]

models <- c("glm_1a_simplest_tminus2",
            "glm_1c_simplest_tminus3",
            "glm_2a_sim_tminus2",
            "glm_3a_comp_tminus2",
           
            "glm_1b_simplest_tminus2_4",
            "glm_2b_sim_tminus2_4",
            "glm_3b_comp_tminus2_4",
            
            "AR2_1a_simplest_tminus2",
            "AR2_2a_sim_tminus2",
            "AR2_3a_comp_tminus2",
           
            "AR2_1b_simplest_tminus2_4",
            "AR2_2b_sim_tminus2_4",
            "AR2_3b_comp_tminus2_4",
           
            "me_1a_simplest_tminus2",
            "me_2a_sim_tminus2",
            "me_3a_comp_tminus2",
           
            "me_1b_simplest_tminus2_4",
            "me_2b_sim_tminus2_4",
            "me_3b_comp_tminus2_4",
           
            "True",
            "Random")

correct <- na_check <- array(0, lengths(list(weeks = vad_weeks, percentile = rev(seq(0,100,10)), model = models)),
                                        list(weeks = vad_weeks, percentile = rev(seq(0,100,10)), model = models))

# A function constructing the counter-factuals --------------------------------------------------
# subset the areas with highest predicted positivity and allocate all tests to those areas
LA_testing_by_quartile <- function(prop_targeted, x_inc, model_number){
  
  dectile <- prop_targeted * 10
  
  j <- model_number
  
  # areas_by_quantile = list of ranked areas generated by the model
  areas <- test$geo_merge[areas_by_quantile[,dectile,j]]
  
  LA_tests_x <- sum(test$total_tests_tminus2) * (x_inc - 1)
  
  areas_sum <- sum(test$total_tests_tminus2[test$geo_merge %in% areas])
  
  multiplier <- 1 + LA_tests_x / areas_sum 
  
  testing_data_by_quartile_df <- test %>%
    mutate(targeted = ifelse(geo_merge %in% areas, TRUE, FALSE),
           tests_area_hyp = ifelse(geo_merge %in% areas, total_tests_tminus2*multiplier, total_tests_tminus2),
           add_tests_area_hyp = ifelse(geo_merge %in% areas, total_tests_tminus2*(multiplier-1), 0),
           pos_hyp = ifelse(geo_merge %in% areas, pct_pos/100 * total_tests_tminus2*multiplier, pct_pos/100 * total_tests_tminus2),
           pos_hyp_baseline =  pct_pos/100 * total_tests_tminus2 ) %>%
    mutate(issue = ifelse(tests_area_hyp > population, TRUE, FALSE),
           tests_multiplier = ifelse(geo_merge %in% areas, multiplier, 1))
  
  return(testing_data_by_quartile_df = testing_data_by_quartile_df)
}

# Creating emply lists for storing results on (1) % correctly predicted the quantile, (2) % increases in cases, and (3) NNT for all weeks 
areas_all_ts <- LA_add_pos_all_ts <- LA_pos_pct_inc_hyp_ts <- pct_inc_targeted_areas_ts <- LA_tests_hyp_all_ts <- targeted_tests_hyp_all_ts <- targeted_pos_hyp_all_ts <- targeted_NNT_hyp_all_ts <- 0

# Main process 1: Getting the list of prioritized areas under each model
for(test_index in 1:length(vad_weeks)){

  # include all previous weeks for training
  all_weeks %>%
    filter(epi_week %in% weeks[1:(test_index-1+28)]) -> train_raw
  
  train <- train_raw[!is.na(train_raw$pct_pos_tminus2) & 
                     !is.na(train_raw$pct_pos_tminus3) & 
                     !is.na(train_raw$test_rate_tminus2) &
                     !is.na(train_raw$pct_cum_doses_tminus2) &
                     !is.na(train_raw$pct_cum_inc_tminus2) &
                     !is.na(train_raw$avg_pct_pos_past_2_4wk),]
  
  # subset the week of interest (i.e. starting from "2021-12-26")
  test_raw <- all_weeks %>%
    filter(epi_week %in% weeks[test_index+28]) 
  
  test <- test_raw[!is.na(test_raw$pct_pos_tminus2) & 
                   !is.na(test_raw$pct_pos_tminus3) & 
                   !is.na(test_raw$test_rate_tminus2) &
                   !is.na(test_raw$pct_cum_doses_tminus2) &
                   !is.na(test_raw$pct_cum_inc_tminus2) &
                   !is.na(test_raw$avg_pct_pos_past_2_4wk),]
  # Using % pos tminus2
  # Simplest models
  glm_pct_pos <- glm(pct_pos ~ pct_pos_tminus2,
                     data = train, 
                     family = gaussian(), 
                     na.action = na.exclude)
  
  test$pred_glm_pct_pos <- predict(glm_pct_pos, newdata = test, na.action = na.exclude)
  
  glm_pct_pos_3 <- glm(pct_pos ~ pct_pos_tminus3,
                     data = train, 
                     family = gaussian(), 
                     na.action = na.exclude)
  
  test$pred_glm_pct_pos_3 <- predict(glm_pct_pos_3, newdata = test, na.action = na.exclude)
  
  AR2_pct_pos <- gls(pct_pos ~ pct_pos_tminus2, 
                     data = train,
                     corr = corARMA(form=~1|id, p=2), 
                     method="REML", 
                     na.action = na.exclude)
  
  test$pred_AR2_pct_pos <- predict(AR2_pct_pos, newdata = test, na.action = na.exclude)
  
  me_pct_pos <- lme(pct_pos ~ pct_pos_tminus2,
                    random = ~ 1 | id,
                    method = "REML",
                    data = train)

  test$pred_me_pct_pos <- predict(me_pct_pos, newdata = test, na.action = na.exclude)
  
  
  # Simple models (% pos + tests per 100)
  glm_sim_tminus2 <- glm(pct_pos ~ pct_pos_tminus2 + test_rate_tminus2,
                         data = train, 
                         family = gaussian(), 
                         na.action = na.exclude)
  
  test$pred_glm_sim_tminus2 <- predict(glm_sim_tminus2, newdata = test, na.action = na.exclude)
  
  AR2_sim_tminus2 <- gls(pct_pos ~ pct_pos_tminus2 + test_rate_tminus2,
                         data = train,
                         corr = corARMA(form=~1|id, p=2), 
                         method="REML", 
                         na.action = na.exclude)
  
  test$pred_AR2_sim_tminus2 <- predict(AR2_sim_tminus2, newdata = test, na.action = na.exclude)
  
  me_sim_tminus2 <- lme(pct_pos ~ pct_pos_tminus2 + test_rate_tminus2,
                        random = ~ 1 | id,
                        method = "REML",
                        data = train, 
                        na.action = na.exclude)

  test$pred_me_sim_tminus2 <- predict(me_sim_tminus2, newdata = test)
  
  # Full model
  glm_comp_tminus2 <- glm(pct_pos ~ pct_pos_tminus2 + test_rate_tminus2 + pct_cum_doses_tminus2 + pct_cum_inc_tminus2,
                          data = train, 
                          family = gaussian(), 
                          na.action = na.exclude)
  
  test$pred_glm_comp_tminus2 <- predict(glm_comp_tminus2, newdata = test)
  
  AR2_comp_tminus2 <- gls(pct_pos ~ pct_pos_tminus2 + test_rate_tminus2 + pct_cum_doses_tminus2 + pct_cum_inc_tminus2,
                          data = train, 
                          corr = corARMA(form=~1|id, p=2), 
                          method="REML", 
                          na.action = na.omit)
  
  test$pred_AR2_comp_tminus2 <- predict(AR2_comp_tminus2, newdata = test, na.action = na.exclude)
  
  me_comp_tminus2 <- lmer(pct_pos ~ (1 | id) + pct_pos_tminus2 + test_rate_tminus2 + pct_cum_doses_tminus2 + pct_cum_inc_tminus2,
                          REML=TRUE,
                          data = train, 
                          na.action = na.omit)
  
  test$pred_me_comp_tminus2 <- predict(me_comp_tminus2, newdata = test, na.action = na.exclude, allow.new.levels = TRUE)
  
  # Using Avg % pos tminus2 to 4 
  # Simplest
  glm_simplest_tminus2_4 <- glm(pct_pos ~ avg_pct_pos_past_2_4wk,
                       data = train, 
                       family = gaussian(), 
                       na.action = na.exclude)
  
  test$pred_glm_simplest_tminus2_4 <- predict(glm_simplest_tminus2_4, newdata = test, na.action = na.exclude)
  
  AR2_simplest_tminus2_4 <- gls(pct_pos ~ avg_pct_pos_past_2_4wk,
                       data = train,
                       corr = corARMA(form=~1|id, p=2), 
                       method="REML", 
                       na.action = na.exclude)
  
  test$pred_AR2_simplest_tminus2_4 <- predict(AR2_simplest_tminus2_4, newdata = test, na.action = na.exclude)
  
  me_simplest_tminus2_4 <- lme(pct_pos ~ avg_pct_pos_past_2_4wk,
                         random = ~ 1 | id,
                         method = "REML",
                         data = train, 
                         na.action = na.exclude)
  
  test$pred_me_simplest_tminus2_4 <- predict(me_simplest_tminus2_4, newdata = test, na.action = na.exclude)
  
  # Reduced (Avg %pos 2 to 4 weeks + tests per 100)
  glm_sim_tminus2_4 <- glm(pct_pos ~ avg_pct_pos_past_2_4wk + test_rate_tminus2,
                           data = train, 
                           family = gaussian(), 
                           na.action = na.exclude)
  
  test$pred_glm_sim_tminus2_4 <- predict(glm_sim_tminus2_4, newdata = test, na.action = na.exclude)
  
  AR2_sim_tminus2_4 <- gls(pct_pos ~ avg_pct_pos_past_2_4wk + test_rate_tminus2,
                           data = train,
                           corr = corARMA(form=~1|id, p=2), 
                           method="REML", 
                           na.action = na.exclude)
  
  test$pred_AR2_sim_tminus2_4 <- predict(AR2_sim_tminus2_4, newdata = test, na.action = na.exclude)
  
  me_sim_tminus2_4 <- lme(pct_pos ~ avg_pct_pos_past_2_4wk + test_rate_tminus2,
                          random = ~ 1 | id,
                          method = "REML",
                          data = train, 
                          na.action = na.omit)
  
  test$pred_me_sim_tminus2_4 <- predict(me_sim_tminus2_4, newdata = test, na.action = na.exclude)
  
  # Full model
  glm_comp_tminus2_4 <- glm(pct_pos ~ avg_pct_pos_past_2_4wk + test_rate_tminus2 + pct_cum_doses_tminus2 + pct_cum_inc_tminus2,
                            data = train, 
                            family = gaussian(), 
                            na.action = na.exclude)
  
  test$pred_glm_comp_tminus2_4 <- predict(glm_comp_tminus2_4, newdata = test, na.action = na.exclude)
  
  AR2_comp_tminus2_4 <- gls(pct_pos ~ avg_pct_pos_past_2_4wk + test_rate_tminus2 + pct_cum_doses_tminus2 + pct_cum_inc_tminus2,
                            data = train,
                            corr = corARMA(form=~1|id, p=2), 
                            method="REML", 
                            na.action = na.exclude)

  test$pred_AR2_comp_tminus2_4 <- predict(AR2_comp_tminus2_4, newdata = test, na.action = na.exclude)
  
  me_comp_tminus2_4 <- lmer(pct_pos ~ (1 | id) + avg_pct_pos_past_2_4wk + test_rate_tminus2 + pct_cum_doses_tminus2 + pct_cum_inc_tminus2,
                           REML=TRUE,
                           data = train, 
                           na.action = na.omit)
  
  test$pred_me_comp_tminus2_4 <- predict(me_comp_tminus2_4, newdata = test, na.action = na.exclude, allow.new.levels = TRUE)
  
# Classifying the areas into quantiles 
  areas_by_quantile <- array(NA, lengths(list(area = test$geo_merge, percentile = seq(10,100,10), model = models)), 
                                         list(area = test$geo_merge, percentile = seq(10,100,10), model = models))
  
  for(i in 1:length(seq(10,100,10))){
    
    areas_by_quantile[,i,1] <- ifelse(quantile(test$pred_glm_pct_pos,(10-i)/10, na.rm = T) <= test$pred_glm_pct_pos, TRUE, FALSE)
    areas_by_quantile[,i,2] <- ifelse(quantile(test$pred_glm_pct_pos_3,(10-i)/10, na.rm = T) <= test$pred_glm_pct_pos_3, TRUE, FALSE)
    areas_by_quantile[,i,3] <- ifelse(quantile(test$pred_glm_sim_tminus2,(10-i)/10, na.rm = T) <= test$pred_glm_sim_tminus2, TRUE, FALSE)
    areas_by_quantile[,i,4] <- ifelse(quantile(test$pred_glm_comp_tminus2,(10-i)/10, na.rm = T) <= test$pred_glm_comp_tminus2, TRUE, FALSE)
    
    areas_by_quantile[,i,5] <- ifelse(quantile(test$pred_glm_simplest_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_glm_simplest_tminus2_4, TRUE, FALSE)
    areas_by_quantile[,i,6] <- ifelse(quantile(test$pred_glm_sim_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_glm_sim_tminus2_4, TRUE, FALSE)
    areas_by_quantile[,i,7] <- ifelse(quantile(test$pred_glm_comp_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_glm_comp_tminus2_4, TRUE, FALSE)

    areas_by_quantile[,i,8] <- ifelse(quantile(test$pred_AR2_pct_pos, (10-i)/10, na.rm = T)<=test$pred_AR2_pct_pos, TRUE, FALSE)
    areas_by_quantile[,i,9] <- ifelse(quantile(test$pred_AR2_sim_tminus2,(10-i)/10, na.rm = T)<=test$pred_AR2_sim_tminus2, TRUE, FALSE)
    areas_by_quantile[,i,10] <- ifelse(quantile(test$pred_AR2_comp_tminus2,(10-i)/10, na.rm = T)<=test$pred_AR2_comp_tminus2, TRUE, FALSE)

    areas_by_quantile[,i,11] <- ifelse(quantile(test$pred_AR2_simplest_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_AR2_simplest_tminus2_4, TRUE, FALSE)
    areas_by_quantile[,i,12] <- ifelse(quantile(test$pred_AR2_sim_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_AR2_sim_tminus2_4, TRUE, FALSE)
    areas_by_quantile[,i,13] <- ifelse(quantile(test$pred_AR2_comp_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_AR2_comp_tminus2_4, TRUE, FALSE)
    
    areas_by_quantile[,i,14] <- ifelse(quantile(test$pred_me_pct_pos,(10-i)/10, na.rm = T)<=test$pred_me_pct_pos, TRUE, FALSE)
    areas_by_quantile[,i,15] <- ifelse(quantile(test$pred_me_sim_tminus2,(10-i)/10, na.rm = T)<=test$pred_me_sim_tminus2, TRUE, FALSE)
    areas_by_quantile[,i,16] <- ifelse(quantile(test$pred_me_comp_tminus2,(10-i)/10, na.rm = T)<=test$pred_me_comp_tminus2, TRUE, FALSE)
 
    areas_by_quantile[,i,17] <- ifelse(quantile(test$pred_me_simplest_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_me_simplest_tminus2_4, TRUE, FALSE)
    areas_by_quantile[,i,18] <- ifelse(quantile(test$pred_me_sim_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_me_sim_tminus2_4, TRUE, FALSE)
    areas_by_quantile[,i,19] <- ifelse(quantile(test$pred_me_comp_tminus2_4,(10-i)/10, na.rm = T)<=test$pred_me_comp_tminus2_4, TRUE, FALSE)
    
    areas_by_quantile[,i,20] <- ifelse(quantile(test$pct_pos,(10-i)/10, na.rm = T)<=test$pct_pos, TRUE, FALSE)
    
    random_string <- sample(test$id, length(test$id), replace = FALSE)
    cut_string <- cut(seq_along(random_string), 10, labels = FALSE)
    areas_by_quantile[,i,21] <- ifelse(as.numeric(test$id) %in% random_string[cut_string <= i], TRUE, FALSE)
    
}

  
# Evaluating model performance -------------------------------------------------
  # Comparing model classified vs true quantiles -------------------------------
for(j in 1:10){
  for(k in 1:21){
     correct[test_index,j+1,k] <- sum((areas_by_quantile[,j,k] == 1) & (areas_by_quantile[,j,20] == 1), na.rm = TRUE) 
     na_check[test_index,j+1,k] <- sum((is.na(areas_by_quantile[,j,k]) | is.na(areas_by_quantile[,j,20]))) # make sure every model predicts some areas 
   }
}

  # Select 10% cities/communities for targeted testing -------------------------
prop_targeted <- seq(0.1,0.2,0.1); pct_targeted_label <- c("10%","20%")

  # Increase # tests in LA County by 1% ----------------------------------------
prop_inc <- seq(1,1.01,0.01)

count_inc <- round((prop_inc - 1) * sum(test$total_tests_tminus2),0)

pct_inc <- paste("+", c("0%","1%"), "(", count_inc, ")")

# Creating empty dataframe for storing results
# Metric 1: Additional cases given intensified testing--------------------------
empty_df <- array(0, lengths(list(pct_targeted = pct_targeted_label, pct_inc = pct_inc, model = models)),
                             list(pct_targeted = pct_targeted_label, pct_inc = pct_inc, model = models))

LA_add_pos_hyp <- LA_pos_pct_inc_hyp <- empty_df

# Additional #/% inc of tests for (1) targeted areas and (2) LA county as a whole
pct_inc_targeted_areas <- LA_add_test_hyp <- LA_tests_hyp <- empty_df

# Metric 2: NNT ----------------------------------------------------------------
targeted_NNT_hyp <- targeted_tests_hyp <- targeted_pos_hyp <- empty_df

for(i in 1:length(prop_targeted)){
  for(j in 1:length(prop_inc)){
    for(k in 1:length(models)){
      
# i<-1
# j<-2
# k<-1
      LA_testing_df <- LA_testing_by_quartile(prop_targeted = prop_targeted[i], x_inc = prop_inc[j], model_number = k)
      
      # Metric 2: % increase in cases compared to % increase in tests under intensified testing
        # Add. #cases ------------------------------------------------------------
        LA_add_pos_hyp[i,j,k] <- sum(LA_testing_df$pos_hyp) - sum(LA_testing_df$pos_hyp_baseline)

        # Add. %inc in #cases ----------------------------------------------------
        LA_pos_pct_inc_hyp[i,j,k] <- LA_add_pos_hyp[i,j,k] / sum(LA_testing_df$pos_hyp_baseline)
      
        # Add. # tests -----------------------------------------------------------
        LA_tests_hyp[i,j,k] <- sum(LA_testing_df$tests_area_hyp)
      
        LA_add_test_hyp[i,j,k] <- sum(LA_testing_df$tests_area_hyp) - sum(LA_testing_df$total_tests_tminus2)
      
        # Add. %inc in tests ----------------------------------------------------
        pct_inc_targeted_areas[i,j,k] <- (mean(LA_testing_df$tests_multiplier[LA_testing_df$tests_multiplier>1]) - 1 ) * 100
      
      # Metric 3: NNT in the targeted areas --------------------------------------------------------------------
        targeted_areas_df <- LA_testing_df %>%
          filter(targeted==TRUE)
       
        # Total cases in the targeted areas
        targeted_pos_hyp[i,j,k] <- sum(targeted_areas_df$pos_hyp)
        
        # Total tests in the targeted areas
        targeted_tests_hyp[i,j,k] <- sum(targeted_areas_df$tests_area_hyp)
        
        # NNT in the targeted areas
        targeted_NNT_hyp[i,j,k] <- targeted_tests_hyp[i,j,k]/targeted_pos_hyp[i,j,k]

   }
 }
}

areas_by_quantile %>% 
  list() %>%
  c(areas_all_ts) -> areas_all_ts

# Hypothetical add. # cases  ---------------------------------------------------
LA_add_pos_hyp %>%
  list() %>%
  c(LA_add_pos_all_ts) -> LA_add_pos_all_ts

# % inc in cases compared to no intensified testing
LA_pos_pct_inc_hyp %>%
  list() %>%
  c(LA_pos_pct_inc_hyp_ts) -> LA_pos_pct_inc_hyp_ts

# Hypothetical add. # tests ----------------------------------------------------
pct_inc_targeted_areas %>%
  list() %>%
  c(pct_inc_targeted_areas_ts) -> pct_inc_targeted_areas_ts

LA_tests_hyp %>%
  list() %>%
  c(LA_tests_hyp_all_ts) -> LA_tests_hyp_all_ts

# Hypothetical NNT in the targeted areas ---------------------------------------

targeted_pos_hyp %>%
  list() %>%
  c(targeted_pos_hyp_all_ts) -> targeted_pos_hyp_all_ts

targeted_tests_hyp %>%
  list() %>%
  c(targeted_tests_hyp_all_ts) -> targeted_tests_hyp_all_ts

targeted_NNT_hyp %>%
  list() %>%
  c(targeted_NNT_hyp_all_ts) -> targeted_NNT_hyp_all_ts

print(test_index)

}

# save outputs
results_all <- list(areas_all_ts, 
                    LA_add_pos_all_ts, 
                    LA_pos_pct_inc_hyp_ts,  pct_inc_targeted_areas_ts, LA_tests_hyp_all_ts, 
                    targeted_pos_hyp_all_ts, 
                    targeted_tests_hyp_all_ts, 
                    targeted_NNT_hyp_all_ts)
names(results_all) <- c("areas_all_ts", "LA_add_pos_all_ts", "LA_pos_pct_inc_hyp_ts",  "pct_inc_targeted_areas_ts", "LA_tests_hyp_all_ts", "targeted_pos_hyp_all_ts", "targeted_tests_hyp_all_ts", "targeted_NNT_hyp_all_ts")

saveRDS(results_all, "R/Outputs/results_all.rds")

# load outputs
results_all <- readRDS("R/Outputs/results_all.rds")
areas_all_ts <- results_all$areas_all_ts
LA_add_pos_all_ts <- results_all$LA_add_pos_all_ts
LA_pos_pct_inc_hyp_ts <- results_all$LA_pos_pct_inc_hyp_ts
pct_inc_targeted_areas_ts <- results_all$pct_inc_targeted_areas_ts
LA_tests_hyp_all_ts <- results_all$LA_tests_hyp_all_ts

targeted_pos_hyp_all_ts <- results_all$targeted_pos_hyp_all_ts
targeted_tests_hyp_all_ts <- results_all$targeted_tests_hyp_all_ts
targeted_NNT_hyp_all_ts <- results_all$targeted_NNT_hyp_all_ts

# Consider 1% increase in testing and all tests being allocated to top 10% areas
# suffix: _10_1
# Additional #cases detected ---------------------------------------------------
empty_10_1 <- array(0, lengths(list(week = vad_weeks, model = models)), 
                               list(week = vad_weeks, model = models))

add_pos_10_1 <- pos_pct_inc_10_1 <- total_pos_10_1 <- empty_10_1

# Add #tests -------------------------------------------------------------------
pct_inc_targeted_areas_10_1 <- add_test_all_ts_10_1 <- total_test_all_ts_10_1 <- empty_10_1

# NNT --------------------------------------------------------------------------
NNT_all_ts_10_1 <- empty_10_1

for(i in 1:length(vad_weeks)){

  week_data <- test_clean %>% 
    filter(epi_week %in% vad_weeks[i])
  
  # Add. #cases ----------------------------------------------------------------
  add_pos_10_1[i,] <- LA_add_pos_all_ts[[length(vad_weeks)-i+1]][1,2,]
  
  pos_pct_inc_10_1[i,] <- LA_pos_pct_inc_hyp_ts[[length(vad_weeks)-i+1]][1,2,]
  
  # Add. #tests ----------------------------------------------------------------
  
  add_test_all_ts_10_1[i,] <- LA_tests_hyp_all_ts[[length(unique(test_weeks$epi_week))-i+1]][1,2,] - sum(week_data$total_tests_tminus2)
  
  # Add. % inc in tests
  pct_inc_targeted_areas_10_1[i,] <- pct_inc_targeted_areas_ts[[length(vad_weeks)-i+1]][1,2,]
  
  # NNT ------------------------------------------------------------------------
  NNT_all_ts_10_1[i,] <- targeted_NNT_hyp_all_ts[[length(vad_weeks)-i+1]][1,2,]

}

# 4 Results
#' 4.1 Identify the model that yield the highest add. cases
#' averaged across all validation weeks
apply(add_pos_10_1,2,sum)/length(vad_weeks)
(-apply(add_pos_10_1,2,sum)/length(vad_weeks)) %>% rank() 
# The model with highest add. cases detected is me_2a_sim_tminus2 

#' 4.2 In the paper, we evaluate the % increase of cases that could have been additionally detected if 
#' testing increase by 1%
apply(pos_pct_inc_10_1,2,mean) * 100

#' 4.3 We are also interested in #/% increase of additional tests additionally administrated by week 
#' which should be the same across all methods. 
#' # of additional tests compared to the previous 2 weeks (equivalent to 1% increase in # tests for the whole LA County)
add_test_all_ts_10_1[,c(1,15,21,20)]
#' % of additional tests compared to the previous 2 weeks for the targeted areas
pct_inc_targeted_areas_10_1[,c(1,15,21,20)]

#' 4.4 Decrease in NNT compared to random allocation
apply((NNT_all_ts_10_1 - NNT_all_ts_10_1[,21])/NNT_all_ts_10_1[,21], 2, mean)
